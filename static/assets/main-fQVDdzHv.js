import{S as u,P as m,W as g,a as w,b as p,A as C,D as l,c,F as f,C as y}from"./three-DDfY4BRC.js";import{R as a}from"./rapier-DUEE_sC_.js";(function(){const n=document.createElement("link").relList;if(!(n&&n.supports&&n.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const i of t)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const i=function(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}(t);fetch(t.href,i)}})();class S{constructor(e){this.canvas=e,this.scene=new u,this.camera=this.createCamera(),this.renderer=this.createRenderer(),this.setupLighting(),this.setupBackground(),this.handleResize(),window.addEventListener("resize",()=>this.handleResize())}createCamera(){const e=new m(60,window.innerWidth/window.innerHeight,.1,1e3);return e.position.set(0,10,15),e.lookAt(0,2,0),e}createRenderer(){const e=new g({canvas:this.canvas,antialias:!0,alpha:!0});return e.setSize(window.innerWidth,window.innerHeight),e.setPixelRatio(Math.min(window.devicePixelRatio,2)),e.shadowMap.enabled=!0,e.shadowMap.type=w,e.outputColorSpace=p,e}setupLighting(){const e=new C(8934911,.4);this.scene.add(e);const t=new l(16768392,.8);t.position.set(5,10,5),t.castShadow=!0,t.shadow.camera.left=-15,t.shadow.camera.right=15,t.shadow.camera.top=15,t.shadow.camera.bottom=-15,t.shadow.mapSize.width=2048,t.shadow.mapSize.height=2048,this.scene.add(t);const i=new c(16711935,1,20);i.position.set(-8,5,0),this.scene.add(i);const o=new c(65535,1,20);o.position.set(8,5,0),this.scene.add(o);const s=new l(16711935,.3);s.position.set(0,5,-10),this.scene.add(s)}setupBackground(){const e=this.createGradientTexture();this.scene.background=e,this.scene.fog=new f(1703987,10,50)}createGradientTexture(){const e=document.createElement("canvas");e.width=2,e.height=256;const t=e.getContext("2d"),i=t.createLinearGradient(0,0,0,256);i.addColorStop(0,"#1a0033"),i.addColorStop(.5,"#330066"),i.addColorStop(1,"#1a0033"),t.fillStyle=i,t.fillRect(0,0,2,256);const o=new y(e);return o.needsUpdate=!0,o}handleResize(){const e=window.innerWidth,t=window.innerHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2))}render(){this.renderer.render(this.scene,this.camera)}add(e){this.scene.add(e)}remove(e){this.scene.remove(e)}dispose(){this.renderer.dispose(),window.removeEventListener("resize",()=>this.handleResize())}}class E{constructor(){this.world=null,this.accumulator=0,this.fixedTimeStep=1/60}async initialize(){console.log("[Physics] Initializing Rapier3D...");try{const e={x:0,y:-9.81,z:0};this.world=new a.World(e),console.log("[Physics] Rapier3D initialized successfully")}catch(e){throw console.error("[Physics] Failed to initialize:",e),e}}step(e){if(this.world)for(this.accumulator+=e;this.accumulator>=this.fixedTimeStep;)this.world.step(),this.accumulator-=this.fixedTimeStep}createDynamicBody(e,t){if(!this.world)throw new Error("Physics not initialized");const i=a.RigidBodyDesc.dynamic().setTranslation(e.x,e.y,e.z),o=this.world.createRigidBody(i);return this.world.createCollider(t,o),o}createKinematicBody(e,t){if(!this.world)throw new Error("Physics not initialized");const i=a.RigidBodyDesc.kinematicPositionBased().setTranslation(e.x,e.y,e.z),o=this.world.createRigidBody(i);return this.world.createCollider(t,o),o}createStaticBody(e,t){if(!this.world)throw new Error("Physics not initialized");const i=a.RigidBodyDesc.fixed().setTranslation(e.x,e.y,e.z),o=this.world.createRigidBody(i);this.world.createCollider(t,o)}createCylinderCollider(e,t,i=.4,o=.2){return a.ColliderDesc.cylinder(t,e).setFriction(i).setRestitution(o)}createCuboidCollider(e,t,i,o=.5,s=.1){return a.ColliderDesc.cuboid(e,t,i).setFriction(o).setRestitution(s)}removeBody(e){this.world&&this.world.removeRigidBody(e)}isReady(){return this.world!==null}}const B=500,r=9999999,M=1e3,d="coinslosh_state",h="1.0.0";class v{constructor(){this.state=this.getDefaultState()}initialize(){const e=this.load();e?(console.log("[State] Loaded saved state:",e),this.state=e):(console.log("[State] Using default state"),this.state=this.getDefaultState(),this.save())}getBalance(){return this.state.coinBalance}setBalance(e){const t=Math.max(0,Math.min(e,r));this.state.coinBalance!==t&&(this.state.coinBalance=t,this.state.timestamp=Date.now(),this.save(),console.log("[State] Balance updated:",t))}addCoins(e){this.setBalance(this.state.coinBalance+e)}subtractCoins(e){this.setBalance(this.state.coinBalance-e)}canDropCoin(){return this.state.coinBalance>0}isMaxBalance(){return this.state.coinBalance>=r}save(){try{const e=JSON.stringify(this.state);localStorage.setItem(d,e)}catch(e){console.error("[State] Failed to save:",e),e instanceof Error&&e.name==="QuotaExceededError"&&console.warn("[State] localStorage quota exceeded")}}load(){try{const e=localStorage.getItem(d);if(!e)return null;const t=JSON.parse(e);return this.validateState(t)?this.migrateState(t):(console.warn("[State] Invalid state in localStorage, using defaults"),null)}catch(e){return console.error("[State] Failed to load:",e),null}}reset(){this.state=this.getDefaultState(),this.save(),console.log("[State] Reset to defaults")}getDefaultState(){return{coinBalance:B,timestamp:Date.now(),version:h,statistics:void 0}}validateState(e){return typeof e=="object"&&e!==null&&!(typeof e.coinBalance!="number"||e.coinBalance<0||e.coinBalance>r)&&!(typeof e.timestamp!="number"||e.timestamp>Date.now())}migrateState(e){let t={...e};return t.version||(t.version=h),t}getState(){return{...this.state}}}class R{constructor(){this.errorTimeout=null,this.coinCountElement=document.getElementById("coin-count"),this.cooldownIndicator=document.getElementById("cooldown-indicator"),this.cooldownTimeElement=document.getElementById("cooldown-time"),this.errorMessageElement=document.getElementById("error-message"),this.loadingScreen=document.getElementById("loading-screen"),this.setupHelpButton()}updateCoinCount(e){this.coinCountElement.textContent=e.toLocaleString()}showCooldown(e){this.cooldownIndicator.style.display="block",this.cooldownTimeElement.textContent=`${(e/1e3).toFixed(1)}s`}hideCooldown(){this.cooldownIndicator.style.display="none"}showError(e,t=3e3){this.errorTimeout!==null&&window.clearTimeout(this.errorTimeout),this.errorMessageElement.textContent=e,this.errorMessageElement.classList.add("show"),this.errorTimeout=window.setTimeout(()=>{this.hideError(),this.errorTimeout=null},t)}hideError(){this.errorMessageElement.classList.remove("show")}hideLoadingScreen(){this.loadingScreen.classList.add("hidden"),setTimeout(()=>{this.loadingScreen.style.display="none"},500)}showLoadingScreen(){this.loadingScreen.style.display="flex",this.loadingScreen.classList.remove("hidden")}setupHelpButton(){const e=document.getElementById("help-button");e&&e.addEventListener("click",()=>{this.showHelp()})}showHelp(){this.showError(`
      \u{1F3B0} COINSLOSH - HOW TO PLAY \u{1F3B0}
      
      1. Click on one of the 4 drop slots to drop a coin
      2. Each drop costs 1 coin
      3. Coins that fall off the FRONT edge earn you 10 coins
      4. Coins that fall off the SIDES are lost
      5. Wait for cooldown between drops
      6. Try to reach the maximum of 999,999 coins!
      
      TIPS:
      \u2022 Watch how the pusher moves coins
      \u2022 Experiment with different slot positions
      \u2022 Coins stack and push each other
    `,8e3)}showMaxBalanceReached(){this.showError("\u{1F389} MAXIMUM BALANCE REACHED! \u{1F389}",5e3)}showNoCoinsLeft(){this.showError("\u26A0\uFE0F No coins left! Wait for coins to win...",3e3)}flashCoinCounter(){this.coinCountElement.style.animation="none",this.coinCountElement.offsetWidth,this.coinCountElement.style.animation="pulse 0.5s ease-out"}}class L{constructor(){this.isRunning=!1,this.lastTime=0,this.cooldownEndTime=0}async initialize(e){console.log("[Game] Initializing CoinSlosh...");try{console.log("[Game] Step 1: UI Controller"),this.uiController=new R,console.log("[Game] Step 2: State Manager"),this.stateManager=new v,this.stateManager.initialize(),this.uiController.updateCoinCount(this.stateManager.getBalance()),console.log("[Game] Step 3: Three.js Scene"),this.sceneManager=new S(e),console.log("[Game] Step 4: Rapier3D Physics (TEMPORARILY DISABLED)"),this.physicsManager=new E,console.log("[Game] Physics initialization skipped for now"),console.log("[Game] Step 5: Building Machine (visual only)"),console.log("[Game] Machine building skipped for now"),console.log("[Game] \u2705 Initialization complete!"),this.uiController.hideLoadingScreen(),this.start()}catch(t){throw console.error("[Game] \u274C Initialization failed at step:",t),console.error("[Game] Error stack:",t instanceof Error?t.stack:"No stack trace"),this.uiController&&this.uiController.showError("Failed to initialize game. Check console for details."),t}}start(){this.isRunning=!0,this.lastTime=performance.now(),this.gameLoop(this.lastTime),console.log("[Game] Game loop started")}stop(){this.isRunning=!1,console.log("[Game] Game loop stopped")}gameLoop(e){if(!this.isRunning)return;const t=Math.min((e-this.lastTime)/1e3,.1);this.lastTime=e,this.updateCooldown(),this.physicsManager.isReady()&&this.physicsManager.step(t),this.sceneManager.render(),requestAnimationFrame(i=>this.gameLoop(i))}updateCooldown(){const e=Date.now();if(this.cooldownEndTime>e){const t=this.cooldownEndTime-e;this.uiController.showCooldown(t)}else this.cooldownEndTime>0&&(this.cooldownEndTime=0,this.uiController.hideCooldown())}isCooldownActive(){return Date.now()<this.cooldownEndTime}startCooldown(){this.cooldownEndTime=Date.now()+M,console.log("[Game] Cooldown started")}dropCoin(e){return this.isCooldownActive()?(console.log("[Game] Drop rejected: cooldown active"),!1):this.stateManager.canDropCoin()?this.stateManager.isMaxBalance()?(console.log("[Game] Drop rejected: max balance"),this.uiController.showMaxBalanceReached(),!1):(console.log(`[Game] Dropping coin in slot ${e}`),this.stateManager.subtractCoins(1),this.uiController.updateCoinCount(this.stateManager.getBalance()),this.startCooldown(),!0):(console.log("[Game] Drop rejected: no coins"),this.uiController.showNoCoinsLeft(),!1)}awardCoins(e){this.stateManager.addCoins(e),this.uiController.updateCoinCount(this.stateManager.getBalance()),this.uiController.flashCoinCounter(),console.log(`[Game] Awarded ${e} coins`)}getSceneManager(){return this.sceneManager}getPhysicsManager(){return this.physicsManager}getStateManager(){return this.stateManager}}console.log("\u{1F4E6} main.ts loaded!"),window.addEventListener("DOMContentLoaded",async()=>{console.log("\u{1F3B0} CoinSlosh Starting..."),console.log("\u{1F310} DOM loaded");const n=document.getElementById("gameCanvas");if(!n)return void console.error("\u274C Canvas element not found!");if(console.log("\u2705 Canvas found:",n),!(n.getContext("webgl2")||n.getContext("webgl")))return alert("WebGL not supported. Please use a modern browser."),void console.error("\u274C WebGL not supported");console.log("\u2705 WebGL supported");try{console.log("\u{1F3AE} Creating GameManager...");const e=new L;console.log("\u{1F527} Initializing game..."),await e.initialize(n),window.game=e,console.log("\u{1F3AE} CoinSlosh ready! Click drop slots to play.")}catch(e){console.error("\u274C Failed to start game:",e),console.error("Stack:",e instanceof Error?e.stack:"No stack"),alert("Failed to initialize game. Please refresh and try again.")}}),document.addEventListener("visibilitychange",()=>{document.hidden?console.log("\u23F8\uFE0F  Game paused (tab hidden)"):console.log("\u25B6\uFE0F  Game resumed")}),window.addEventListener("beforeunload",()=>{console.log("\u{1F4BE} Saving game state...")});
